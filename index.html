<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS-875Q — Driver Knowledge Quiz</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --card:#111827;      /* gray-900 */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --accent:#22c55e;    /* green-500 */
      --accent-2:#3b82f6;  /* blue-500 */
      --danger:#ef4444;    /* red-500 */
      --warn:#f59e0b;      /* amber-500 */
      --ring:#60a5fa;      /* blue-400 */
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg, #0b1225, #0f172a 35%, #0b1225 100%);
      color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:24px;}
    .app-title{font-size:clamp(22px, 3vw, 34px); font-weight:800; letter-spacing:.5px; margin:6px 0 2px}
    .sub{color:var(--muted); font-size:14px}
    .card{background:rgba(17,24,39,.9); border:1px solid rgba(148,163,184,.15); border-radius:var(--radius); padding:18px; box-shadow:0 15px 40px rgba(0,0,0,.35)}
    .grid{display:grid; gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width:780px){ .grid.cols-2{grid-template-columns:1fr}}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type=text]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(148,163,184,.25); background:#0b1225; color:var(--text);
      outline:none; transition:.2s border-color, .2s box-shadow;
    }
    input[type=text]:focus{ border-color:var(--ring); box-shadow:0 0 0 4px rgba(96,165,250,.2)}
    .btn{appearance:none; border:0; background:var(--accent); color:#05130a; font-weight:700; padding:12px 16px; border-radius:12px; cursor:pointer; box-shadow:0 6px 20px rgba(34,197,94,.35);}    
    .btn:hover{filter:brightness(1.05)}
    .btn.secondary{ background:var(--accent-2); color:#041226; box-shadow:0 6px 20px rgba(59,130,246,.3)}
    .btn.ghost{ background:transparent; border:1px solid rgba(148,163,184,.25); color:var(--text)}
    .btn.warn{ background:var(--warn); color:#160f00 }
    .btn.danger{ background:var(--danger); color:#2b0707 }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .space{height:10px}
    .question{ border:1px solid rgba(148,163,184,.2); border-radius:16px; padding:16px; background:#0b1326; }
    .q-head{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between }
    .q-numb{ font-weight:800; background:#0a0f1d; border:1px solid rgba(148,163,184,.25); color:#93c5fd; padding:4px 10px; border-radius:999px; font-size:12px; letter-spacing:.5px }
    .q-text{ font-size:18px; line-height:1.45; font-weight:700;}
    .choices{ margin-top:12px; display:grid; gap:8px }
    .choice{ position:relative; display:flex; gap:10px; align-items:flex-start; border:1px solid rgba(148,163,184,.2); background:#0c162d; padding:10px 12px; border-radius:12px; cursor:pointer; }
    .choice:hover{ border-color:var(--ring)}
    .choice input{ margin-top:2px }
    .meta{ color:var(--muted); font-size:12px }
    .progress{ height:10px; background:rgba(148,163,184,.2); border-radius:999px; overflow:hidden; border:1px solid rgba(148,163,184,.2) }
    .progress > span{ display:block; height:100%; background:linear-gradient(90deg, var(--accent), #16a34a); width:0 }
    .pill{ padding:6px 10px; border:1px solid rgba(148,163,184,.25); border-radius:999px; font-size:12px; color:var(--muted) }
    .pill-good{ color:#05240f; background:rgba(34,197,94,.85); border-color:transparent }
    .pill-bad{ color:#2b0707; background:rgba(239,68,68,.9); border-color:transparent }
    .hidden{ display:none }
    .divider{ height:1px; background:rgba(148,163,184,.2); margin:10px 0 }
    .sectionLabel{ font-weight:800; color:#67e8f9; margin-bottom:6px }
    .pager{display:flex; justify-content:space-between; gap:10px; margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div>
        <div class="app-title">DS-875Q Driver Knowledge Quiz</div>
        <div class="sub">Mobile-friendly • Randomized • 5-per-page • A/B labeling</div>
      </div>
    </div>

    <!-- START -->
    <div id="screenStart" class="card">
      <div class="grid cols-2">
        <div>
          <label for="inpName">Driver Name</label>
          <input type="text" id="inpName" placeholder="e.g., Paul Bryan" />
        </div>
        <div>
          <label for="inpID">License Number</label>
          <input type="text" id="inpID" placeholder="e.g., A1234567" />
        </div>
      </div>
      <div class="space"></div>
      <div class="row">
        <button class="btn" id="btnStart">Start Quiz</button>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="screenQuiz" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="row" style="gap:8px; align-items:center">
          <span id="lblCandidate" class="pill"></span>
          <span id="lblSection" class="pill"></span>
          <span id="lblAttempt" class="pill"></span>
        </div>
        <div style="min-width:160px">
          <div class="meta" id="lblProg">0 / 0</div>
          <div class="progress" aria-hidden="true"><span id="bar"></span></div>
        </div>
      </div>
      <div class="divider"></div>
      <div id="quizMount" class="grid"></div>
      <div class="pager">
        <button class="btn ghost" id="btnPrev">← Previous</button>
        <button class="btn secondary" id="btnNext">Next →</button>
      </div>
      <div class="space"></div>
      <div class="row">
        <button class="btn warn" id="btnSubmit">Submit</button>
        <button class="btn ghost" id="btnAbort">Abort</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="screenResult" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="row" style="gap:8px; align-items:center">
          <span id="lblCandidate2" class="pill"></span>
          <span id="lblAttempt2" class="pill"></span>
        </div>
        <div class="row" style="gap:8px">
          <span id="lblScore" class="pill pill-good"></span>
        </div>
      </div>
      <div class="space"></div>
      <div id="reviewMount" class="grid"></div>
      <div class="space"></div>
      <div class="meta" id="postNote">Results were sent to the admin sheet.</div>
    </div>
  </div>

  <script>
    /* ============================
       Google Form hookup (your IDs)
    ============================ */
    const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScpnw5p7_tSVDEHnyRBXCn3BhfBh9mB2FYFQQMa8up_txLv/formResponse';
    const ENTRY = {
      name:     'entry.335663759',   // Driver Name
      license:  'entry.278148074',   // License Number
      secA:     'entry.166676910',   // Section A (e.g., 12/15)
      secB:     'entry.373047882',   // Section B (e.g., 4/5)
      total:    'entry.2074083010',  // Total score (e.g., 16/20)
      overall:  'entry.1567472785',  // PASS/FAIL
      startISO: 'entry.2140359899',  // Started timestamp
      endISO:   'entry.1657520346'   // Ended timestamp
    };

    function toFormBody(obj){
      return Object.entries(obj)
        .map(([k,v]) => encodeURIComponent(k)+'='+encodeURIComponent(v==null?'':String(v))).join('&');
    }
    async function postSubmissionToGoogleForm(payload){
      try{
        await fetch(FORM_URL, {
          method:'POST', mode:'no-cors',
          headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body: toFormBody(payload)
        });
        console.log('✅ Sent to Google Form');
      }catch(e){ console.warn('Form post failed:', e); }
    }

    /* ============================
       Minimal quiz engine
    ============================ */
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));

    function hash32(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0;}
    function mulberry32(a){ return function(){ a|=0; a=a+0x6D2B79F5|0; let t=Math.imul(a^a>>>15,1|a); t=t+Math.imul(t^t>>>7,61|t)^t; return ((t^t>>>14)>>>0)/4294967296; } }
    function shuffle(arr, rng=Math.random){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    const PER_PAGE = 5;
    const MAX_ATTEMPTS = 2;
    const LS_PREFIX = 'ds875q';
    let BANK = [];
    let attempt = null; // {name,id,items:[{q,choices,ansIdx,sel}], start, page, attemptIdx}

    async function loadBank(){
      // prefer external JSON, fallback to embedded
      try{
        const r = await fetch('DS-875Q_question_bank.json', {cache:'no-store'});
        if (r.ok){ BANK = await r.json(); console.log('Loaded bank from JSON:', BANK.length); return; }
      }catch{}
      const embedded = document.getElementById('embeddedBank');
      if (embedded){ BANK = JSON.parse(embedded.textContent.trim()); console.log('Loaded embedded bank:', BANK.length); }
    }

    function buildAttempt(name,id){
      // A15 + B5 selection (or whatever bank has), answer choices shuffled
      const seed = hash32(`${name}|${id}|${Date.now()}`);
      const rng = mulberry32(seed);
      const poolA = BANK.filter(q=>String(q.section).toUpperCase()==='A');
      const poolB = BANK.filter(q=>String(q.section).toUpperCase()==='B');

      const pickA = shuffle(poolA,rng).slice(0, Math.min(15, poolA.length));
      const pickB = shuffle(poolB,rng).slice(0, Math.min(5,  poolB.length));
      const picked = pickA.concat(pickB);

      const items = picked.map(q=>{
        const ch = shuffle(q.choices, rng);
        const ansIdx = ch.findIndex(x=>x===q.choices[q.answerIndex]);
        return { q, choices: ch, ansIdx, sel:-1 };
      });

      const key = `${LS_PREFIX}|${name}|${id}|count`;
      const soFar = parseInt(localStorage.getItem(key)||'0',10);
      localStorage.setItem(key, String(soFar+1));

      attempt = { name, id, items, start:Date.now(), page:0, attemptIdx: soFar+1 };
    }

    function attemptsFor(name,id){
      const key = `${LS_PREFIX}|${name}|${id}|count`;
      return parseInt(localStorage.getItem(key)||'0',10);
    }

    function renderQuizPage(){
      $("#screenStart").classList.add("hidden");
      $("#screenResult").classList.add("hidden");
      $("#screenQuiz").classList.remove("hidden");

      $("#lblCandidate").textContent = attempt.name || "Unknown";
      $("#lblSection").textContent = "A + B (20 questions)";
      $("#lblAttempt").textContent = `Attempt #${attempt.attemptIdx}`;

      const startIdx = attempt.page * PER_PAGE;
      const pageItems = attempt.items.slice(startIdx, startIdx + PER_PAGE);

      const mount = $("#quizMount");
      mount.innerHTML = "";

      pageItems.forEach((it, idx)=>{
        const abs = startIdx + idx;
        const div = document.createElement('div');
        div.className = "question";
        div.innerHTML = `
          <div class="q-head">
            <div class="q-numb">#${abs+1}</div>
            <div class="sectionLabel">Section ${it.q.section}</div>
          </div>
          <div class="q-text">${escapeHtml(it.q.text)}</div>
          <div class="choices">
            ${it.choices.map((c,i)=>`
              <label class="choice">
                <input type="radio" name="q${abs}" value="${i}" ${it.sel===i?"checked":""}/>
                <div>${escapeHtml(String.fromCharCode(97+i)+". "+c)}</div>
              </label>
            `).join("")}
          </div>
        `;
        mount.appendChild(div);
      });

      // wire radios
      $$("input[type=radio]").forEach(r=>{
        r.addEventListener('change', e=>{
          const nm = e.target.name; // q#
          const abs = parseInt(nm.slice(1),10);
          attempt.items[abs].sel = parseInt(e.target.value,10);
          updateProgress();
        });
      });

      const total = attempt.items.length;
      const answered = attempt.items.filter(x=>x.sel>=0).length;
      $("#lblProg").textContent = `${answered} / ${total}`;
      $("#bar").style.width = Math.round(100*answered/total) + "%";

      $("#btnPrev").disabled = attempt.page===0;
      $("#btnNext").disabled = (startIdx + PER_PAGE) >= total;
    }

    function updateProgress(){
      const total = attempt.items.length;
      const answered = attempt.items.filter(x=>x.sel>=0).length;
      $("#lblProg").textContent = `${answered} / ${total}`;
      $("#bar").style.width = Math.round(100*answered/total) + "%";
    }

    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function breakdownBySection(attempt){
      const by = {A:{correct:0,total:0}, B:{correct:0,total:0}};
      attempt.items.forEach(it=>{
        const sec = String(it.q.section||'A').toUpperCase();
        if (!by[sec]) return;
        by[sec].total++;
        if (it.sel===it.ansIdx) by[sec].correct++;
      });
      return by;
    }
    function totalGrade(attempt){
      const t = attempt.items.length;
      const c = attempt.items.reduce((n,it)=> n + (it.sel===it.ansIdx?1:0), 0);
      return {correct:c, total:t, percent: t? Math.round(100*c/t):0};
    }

    function showResults(){
      const by = breakdownBySection(attempt);
      const g  = totalGrade(attempt);

      const passA = (by.A.total===0) || (by.A.correct>=12 && by.A.total===15);
      const passB = (by.B.total===0) || (by.B.correct>=4  && by.B.total===5);
      const overall = (passA && passB);
      const secAText = `${by.A.correct}/${by.A.total}`;
      const secBText = `${by.B.correct}/${by.B.total}`;
      const totalTxt = `${g.correct}/${g.total}`;

      $("#screenQuiz").classList.add("hidden");
      $("#screenResult").classList.remove("hidden");
      $("#lblCandidate2").textContent = attempt.name || "Unknown";
      $("#lblAttempt2").textContent = `Attempt #${attempt.attemptIdx}`;
      $("#lblScore").textContent = `A ${secAText} • B ${secBText} • Total ${totalTxt} • ${g.percent}% • ${overall?'PASS':'FAIL'}`;

      const mount = $("#reviewMount");
      mount.innerHTML = "";
      attempt.items.forEach((it, idx)=>{
        const ok = it.sel===it.ansIdx;
        const block = document.createElement('div');
        block.className = "question";
        block.innerHTML = `
          <div class="q-head">
            <div class="q-numb">#${idx+1}</div>
            <div class="pill ${ok?'pill-good':'pill-bad'}">${ok?'Correct':'Incorrect'}</div>
          </div>
          <div class="q-text">${escapeHtml(it.q.text)}</div>
          <div class="choices" style="margin-top:8px">
            ${it.choices.map((c,i)=>{
              const isAns = i===it.ansIdx;
              const isMine = i===it.sel;
              const style = isAns?'style="border-color:rgba(34,197,94,.7)"':'';
              return `<div class='choice' ${style}>${escapeHtml(String.fromCharCode(97+i)+". "+c)} ${isAns?'<span class="pill pill-good" style="margin-left:8px">Answer</span>':''} ${isMine?'<span class="pill" style="margin-left:8px">Your choice</span>':''}</div>`;
            }).join("")}
          </div>`;
        mount.appendChild(block);
      });

      // send to Google Form (fire-and-forget)
      const payload = {};
      payload[ENTRY.name]     = attempt.name || '';
      payload[ENTRY.license]  = attempt.id || '';
      payload[ENTRY.secA]     = secAText;
      payload[ENTRY.secB]     = secBText;
      payload[ENTRY.total]    = totalTxt;
      payload[ENTRY.overall]  = overall ? 'PASS':'FAIL';
      payload[ENTRY.startISO] = new Date(attempt.start).toISOString();
      payload[ENTRY.endISO]   = new Date(Date.now()).toISOString();
      postSubmissionToGoogleForm(payload);
    }

    /* ============================
       Events
    ============================ */
    $("#btnStart").addEventListener('click', async ()=>{
      const name = $("#inpName").value.trim();
      const id   = $("#inpID").value.trim();
      if (!name || !id){ alert("Enter Driver Name and License Number"); return; }

      // enforce 2 attempts per driver per device
      const used = attemptsFor(name,id);
      if (used >= MAX_ATTEMPTS){
        alert("Maximum attempts reached for this driver on this device.");
        return;
      }

      if (!BANK.length) await loadBank();
      if (!BANK.length){ alert("Question bank not found."); return; }

      buildAttempt(name,id);
      renderQuizPage();
    });

    $("#btnPrev").addEventListener('click', ()=>{
      if (!attempt) return;
      if (attempt.page>0){ attempt.page--; renderQuizPage(); }
    });
    $("#btnNext").addEventListener('click', ()=>{
      if (!attempt) return;
      const maxPage = Math.ceil(attempt.items.length / PER_PAGE) - 1;
      if (attempt.page<maxPage){ attempt.page++; renderQuizPage(); }
    });

    $("#btnAbort").addEventListener('click', ()=>{
      if (!confirm('Abort this attempt and go back to Start?')) return;
      attempt=null;
      $("#screenQuiz").classList.add("hidden");
      $("#screenResult").classList.add("hidden");
      $("#screenStart").classList.remove("hidden");
    });

    $("#btnSubmit").addEventListener('click', ()=>{
      if (!attempt) return;
      const unanswered = attempt.items.filter(x=>x.sel<0).length;
      if (unanswered>0 && !confirm(`You have ${unanswered} unanswered. Submit anyway?`)) return;
      showResults();
    });
  </script>

  <!-- Optional inline bank:
       If you want a one-file page (no external JSON), paste your array below and delete this comment.
  <script id="embeddedBank" type="application/json">[{"id":"1","section":"A","text":"Sample?","choices":["A","B","C","D"],"answerIndex":0}]</script>
  -->
</body>
</html>
